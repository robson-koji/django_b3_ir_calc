{% extends 'base.html' %}
{% load iterate_dicts %}
{% load mathfilters %}
{% block content %}


<style media="screen">
  h3:after {
    content:"";
    /* top:80%; */
    bottom: 7px;
    left: 0;
    right: 0;

    width:97%;
    margin-left:15px;

    height:2px;
    position:absolute;
    background:#4264ab;

}
</style>



      <!-- Dashboard wrapper start -->
      <div class="dashboard-wrapper">

        <!-- Page title start -->
        <div class="page-title clearfix">
          <h2>
            History {% if stock_detail %} detail - <a target="_blank" href="https://br.tradingview.com/chart?symbol=BMFBOVESPA%3A{{ stock_detail  }}">{{ stock_detail  }}</a> {% endif %}


            <small>
              <ul>
                <li>Home</li>
                <li>/</li>
                <li>Dashboard</li>
                <li>/</li>
                <li>Tables</li>
              </ul>
            </small>
          </h2>
        </div>
        <!-- Page title end -->
        {% if not stock_detail %}
          <button data-toggle="collapse" data-target=".account_balance">Collapse all Account Balance</button>
        {% elif stock_detail and show_chart %}
          <button data-toggle="collapse" data-target=".account_balance">Collapse all Account Balance</button>
          {% include "stacked_1.html" %}
        {% elif stock_detail and not show_chart %}

        <div class="row">
          <div>
            <div class="panel panel-yellow">
              <div class="panel-heading">
                <h3 class="panel-title">Chart not available</h3>
              </div>
              <div class="panel-body">
                Not enough data to display chart, due to Corporate Events.
              </div>
            </div>
          </div>
        </div>


        {% endif %}




        {% for key, value in months.items %}



        cagation nesse loop
        {% if value.dayt %}
            {% for day in value.dayt  %}
              {{ day }}
              {% with value.dayt|get_item:day as stock_dict %}
                  <!-- {{ stock }} -->
                  {% for stock, values in stock_dict.items %}
                    <h3>{{ day }} - {{ stock }}</h3>

                    {% with stock_dict|get_item:stock as stock_dict %}
                      {% comment %}
                        {% for keys in stock %}
                          {{ keys }}
                          qt_total_sold_dayt qt_total_bought_dayt
                          total_amount_sold_dayt total_amount_bought_dayt
                          reconciled_dayt_operations
                          operation_result
                          avg_price_bought
                          avg_price_sold
                        {% endfor %}
                      {% endcomment %}
                      {{ stock_dict }}

                      <p>qt_total_dayt:{{ stock_dict.qt_total_dayt }}<br>
                      total_amount_sold_dayt:{{ stock_dict.total_amount_sold_dayt }}<br>
                      total_amount_bought_dayt:{{ stock_dict.total_amount_bought_dayt }}<br>
                      operation_result:{{ stock_dict.operation_result }}<br>
                      avg_price_bought:{{ stock_dict.avg_price_bought }}<br>
                      avg_price_sold:{{ stock_dict.avg_price_sold }}</p>




                      <p>reconciled_bought_operations:{{ stock_dict.reconciled_bought_operations }}<br>
                      <p>reconciled_sold_operations:{{ stock_dict.reconciled_sold_operations }}<br>

                      <p>qt_initial_operations:{{ stock_dict.qt_initial_operations }}<br>

                      <p>qt_remaining_operations:{{ stock_dict.qt_remaining_operations }}<br>
                      <p>qt_real_dt_operations:{{ stock_dict.qt_real_dt_operations }}<br>




                    {% endwith %}

                  {% endfor %}
              {% endwith %}
            {% endfor %}
        {% endif %}





        <!-- Row start -->
        <div class="row">
          <div class="col-md-12">

          <h3 style="display: inline-block">{{ value.dt|date:"F Y" }} </h3>
          <button data-toggle="collapse" data-target="#ab_{{ key|safe }}" style="float: right;">Account Balance</button>

          </div>

          <div class="col-md-3">
            <div class="widget">
              <div class="widget-header">
                <div class="title">
                  <span class="fs1" aria-hidden="true" data-icon=""></span> Transactions
                </div>
              </div>
              <div class="widget-body">
                <table class="table table-condensed table-bordered table-hover no-margin">
                  <tbody>
                    <tr>
                      <th style="width:60%">Buy ({{ value.qt_buy }})</th>
                      <td style="width:40%" class="text-right"><span class="label label-primary label_cp1">{{ value.month_buy }}</span></td>
                    </tr>
                    <tr>
                      <th>Sell ({{ value.qt_sell }})</th>
                      <td class="text-right"><span class="label label-primary label_cp1">{{ value.month_sell }}</span></td>
                    </tr>
                    <tr>
                      <th>Total ({{  value.qt_buy | addition:value.qt_sell }})</th>
                      <td class="text-right"><span class="label label-primary label_cp1">{{  value.month_buy | addition:value.month_sell }}</span></td>
                    </tr>
                  </tbody>
                </table>
              </div>
            </div>
          </div>


          <div class="col-md-3">
            <div class="widget">
              <div class="widget-header">
                <div class="title">
                  <span class="fs1" aria-hidden="true" data-icon=""></span> Taxes
                </div>
              </div>
              <div class="widget-body">
                <table class="table table-condensed table-bordered table-hover no-margin">
                  <tbody>
                    <tr>
                      <th style="width:60%">B3 Taxes</th>
                      <td style="width:40%" class="text-right"><span class="label label-default label_cp1">{{ value.b3_taxes }}</span></td>
                    </tr>
                    <tr>
                      <th>Broker Fees</th>
                      <td class="text-right"><span class="label label-default label_cp1">{{ value.broker_taxes }}</span></td>
                    </tr>
                    <tr>
                      <th>IRPF Withholding</th>
                      <td class="text-right"><span class="label label-default label_cp1">{{ value.irpf_withholding }}</span></td>
                    </tr>
                    <tr>
                      <th>Sum Taxes</th>
                      <td class="text-right"><span class="label label-default label_cp1">{{ value.sum_taxes }}</span></td>
                    </tr>


                  </tbody>
                </table>
              </div>
            </div>
          </div>



          <!-- Span4 start -->
          <div class="col-md-3">
            <div class="widget">
              <div class="widget-header">
                <div class="title">
                  <span class="fs1" aria-hidden="true" data-icon=""></span> Outcome
                </div>
              </div>
              <div class="widget-body">
                <table class="table table-condensed table-bordered table-hover no-margin">
                  <tbody>
                    {% if value.month_gain == 0 and value.month_loss == 0 %}
                    <tr>
                      <th style="width:60%">Month</th>
                      <td style="width:40%" class="text-right"><span class="label label-default label_cp1">0.00</span></td>
                    </tr>
                    <tr>
                      <th>Month Net Loss</th>
                      <td class="text-right"><span class="label label-danger label_cp1">{{ value.month_net_loss|floatformat:"2" }}</span>
                      </td>
                    </tr>
                    {% elif value.month_gain > 0 %}
                    <tr>
                      <th style="width:60%">Month Gain</th>
                      <td style="width:40%" class="text-right"><span class="label label-success label_cp1">{{ value.month_gain|floatformat:"2" }}</span></td>
                    </tr>
                    <tr>
                      <th>Month Net Gain</th>
                      <td class="text-right"><span class="label label-success label_cp1">{{ value.month_net_gain|floatformat:"2" }}</span>
                      </td>
                    </tr>
                    {% elif value.month_loss < 0 %}
                    <tr>
                      <th>Month Loss</th>
                      <td class="text-right"><span class="label label-danger label_cp1">{{ value.month_loss|floatformat:"2" }}</span>
                      </td>
                    </tr>
                    <tr>
                      <th>Month Net Loss</th>
                      <td class="text-right"><span class="label label-danger label_cp1">{{ value.month_net_loss|floatformat:"2" }}</span>
                      </td>
                    </tr>
                    {% endif %}
                    <tr>
                      <th>Prev. Accum. Loss</th>
                      <td class="text-right"><span class="label label-danger label_cp1">{{ value.prev_month_cumulate_loss|floatformat:"2" }}</span></td>
                    </tr>
                    {% if value.cumulate_gain > 0 %}
                    <tr>
                      <th style="width:60%">This Month Gain</th>
                      <td style="width:40%" class="text-right"><span class="label label-success label_cp1">{{ value.cumulate_gain|floatformat:"2" }}</span></td>
                    </tr>
                    {% else %}
                    <tr>
                      <th>This Accum. Loss</th>
                      <td class="text-right"><span class="label label-danger label_cp1">{{ value.cumulate_loss|floatformat:"2" }}</span></td>
                    </tr>
                    {% endif %}
                  </tbody>
                </table>
              </div>
            </div>
          </div>
          <!-- Span4 end -->

          <!-- Span4 start -->
          <div class="col-md-3">
            <div class="widget">
              <div class="widget-header">
                <div class="title">
                  <span class="fs1" aria-hidden="true" data-icon=""></span> Due IRPF
                </div>
              </div>
              <div class="widget-body">
                <table class="table table-condensed table-bordered table-hover no-margin">
                  <tbody>
                    <tr>
                      <th style="width:60%">Month Net Gain</th>
                      <td style="width:40%" class="text-right"><span class="label label-warning label_cp1">{{ value.cumulate_gain|floatformat:"2" }}</span></td>
                    </tr>
                    <tr>
                      <th>Month Sales</th>
                      <td class="text-right"><span class="label label-warning label_cp1">{{ value.month_sell }}</span></td>
                    </tr>
                    <tr class="bg-warning">
                    {% if value.cumulate_gain > 0 and  value.month_sell > 20000  %}
                      <th colspan="2" scope="row" class="text-center"><a href="https://sicalc.receita.economia.gov.br/sicalc/rapido/contribuinte" target="_blank">Pay {{ value.tax.tax_amount|floatformat:"2" }}</a></th>
                    {% else %}
                      <th colspan="2" class="text-center">No tax due</th>
                    {% endif %}
                  </tr>
                  </tbody>
                </table>
              </div>


            </div>
          </div>
          <!-- Span4 end -->


          <div id="ab_{{ key|safe }}" class="col-md-12 collapse account_balance" data-toggle="false">
            <div class="widget">
              <div class="widget-header">
                <div class="title">
                  <span class="fs1" aria-hidden="true" data-icon=""></span> Account Balance
                </div>
              </div>

                      {% with months_operations|get_item:key as operations %}
                      <table class="table table-condensed table-striped table-hover table-bordered pull-left" id="data-table_{{ value.dt|date:"F Y" }}_2">
                        <thead>
                          <tr>
                            <th></th>
                            <th colspan='6' class="text-center">Operation</th>
                            <th colspan='4' class="text-center">Position</th>
                          </tr>
                          <tr>
                            <th></th>

                            <th>Oper</th>
                            <th>Dt</th>
                            <th>Qt</th>
                            <th>Value</th>
                            <th>Price</th>
                            <th>Profit</th>
                            <th>Loss</th>

                            <th>Qt</th>
                            <th>AvgPrice</th>
                            <th>AvgPricePrev</th>
                          </tr>
                        </thead>
                        <tbody>
                        {% for stock, value in operations.items %}
                        {% for oper in value %}
                          <tr>
                              <td><a href={% url 'history_detail' stock=oper.name %}>{{oper.name}}</a></td>
                              <td>{{oper.buy_sell}}</td>
                              <td>{{oper.dt}}</td>
                              <td>{{oper.qt}}</td>
                              <td>{{oper.value}}</td>
                              <td>{{oper.unit_price}}</td>
                              <td>{{oper.profit|floatformat:"2"}}</td>
                              <td>{{oper.loss|floatformat:"2"}}</td>

                              <td>{{oper.qt_total}}</td>
                              <td>{{oper.avg_price|floatformat:"2"}}</td>
                              <td>{{oper.avg_price_prev|floatformat:"2"}}</td>
                          </tr>
                          {% endfor %}
                        {% endfor %}
                      </tbody>
                      </table>
                      {% endwith %}


            </div>
            <!-- Row end -->
          </div>
      </div>
      {% endfor %}
      <!-- Dashboard wrapper end -->
    </div>


{% endblock content %}
